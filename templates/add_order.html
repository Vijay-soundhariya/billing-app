{% extends "base.html" %}
{% block content %}
<h3>Add Order</h3>

<form method="post" id="orderForm">

  <!-- CUSTOMER SECTION -->
  <div class="row g-2 mb-4">
    <div class="col-md-4">
      <input id="customer_phone" name="customer_phone" class="form-control" placeholder="Customer phone" required>
    </div>
    <div class="col-md-4">
      <input id="customer_name" name="customer_name" class="form-control" placeholder="Customer name" required>
    </div>
  </div>

  <!-- PRODUCT SEARCH -->
  <div class="mb-3">
    <input type="text" id="product_search" class="form-control" placeholder="Search product...">
    <div id="search_results" class="list-group"></div>
  </div>

  <!-- SELECTED PRODUCT DETAILS -->
  <div id="selected_product_box" style="display:none;" class="card p-3 mb-3">
    <h5 id="prod_name"></h5>
    <p>Price: ₹<span id="prod_price"></span></p>
    <p>GST: <span id="prod_gst"></span>%</p>
    <p>Available: <span id="prod_avail"></span></p>

    <input type="number" id="prod_qty" class="form-control mb-2" placeholder="Enter quantity" min="1">
    <button type="button" class="btn btn-success" id="add_item_btn">Add Item</button>
  </div>

  <!-- BILL TABLE -->
  <table class="table" id="bill_table">
    <thead>
      <tr>
        <th>Item</th><th>Qty</th><th>Price</th><th>GST%</th><th>Line</th><th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="btn btn-primary">Create Order</button>
</form>

<script>
let selectedProduct = null;

// Customer autofill
document.getElementById('customer_phone').addEventListener('blur', ()=>{
  const phone = customer_phone.value.trim();
  if (!phone) return;
  fetch('/get_customer_by_phone?phone='+phone)
    .then(r=>r.json())
    .then(d=>{
      if (d.name) customer_name.value = d.name;
    });
});

// Product search
document.getElementById("product_search").addEventListener("input", function(){
  let q = this.value.trim();
  if (!q) { document.getElementById("search_results").innerHTML = ""; return; }
  fetch("/api/search_products?q="+q)
    .then(r=>r.json())
    .then(list=>{
      let html = "";
      list.forEach(p=>{
        html += `<a href="#" class="list-group-item list-group-item-action"
                    onclick="selectProduct(${p.id}, '${p.name}', ${p.price}, ${p.gst}, ${p.available})">
                    ${p.name} (₹${p.price})
                 </a>`;
      });
      document.getElementById("search_results").innerHTML = html;
    });
});

function selectProduct(id, name, price, gst, avail){
  selectedProduct = {id, name, price, gst, avail};
  document.getElementById("prod_name").innerText = name;
  document.getElementById("prod_price").innerText = price;
  document.getElementById("prod_gst").innerText = gst;
  document.getElementById("prod_avail").innerText = avail;
  document.getElementById("selected_product_box").style.display = "block";
  document.getElementById("search_results").innerHTML = "";
  document.getElementById("product_search").value = "";
}

document.getElementById("add_item_btn").addEventListener("click", ()=>{
  const qty = parseInt(document.getElementById("prod_qty").value);
  if (!qty || qty < 1) return alert("Enter valid quantity");
  if (qty > selectedProduct.avail) return alert("Not enough stock");

  const tbody = document.querySelector("#bill_table tbody");
  const line = selectedProduct.price * qty;

  tbody.innerHTML += `
    <tr>
      <td>${selectedProduct.name}</td>
      <td>${qty}</td>
      <td>₹${selectedProduct.price}</td>
      <td>${selectedProduct.gst}%</td>
      <td>₹${line.toFixed(2)}</td>
      <td><button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">X</button></td>
      <input type="hidden" name="qty_${selectedProduct.id}" value="${qty}">
    </tr>
  `;

  document.getElementById("selected_product_box").style.display = "none";
  document.getElementById("prod_qty").value = "";
});
</script>

{% endblock %}
